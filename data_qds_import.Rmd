---
title: "Import and clean QDS data"
date: "2020-12-23"
---

```{r}
library(dplyr)
library(haven)
library(stringr)
library(tidyr)
library(meantables)
library(freqtables)
library(purrr)
library(flextable)
library(officer)
```

# Import data

This data is exported from QDS in SPSS data format. The SPSS data is then added to the UTHealth Servers. Currently, I'm not sure who is doing this. 

```{r}
all_visits <- read_sav("/Users/bradcannell/Desktop/l2c/All_Visits_Data.SAV")
```

```{r}
dim(all_visits) # 258 2722
```


# Data management

## Convert to lowercase

```{r}
names(all_visits) <- names(all_visits) %>% str_to_lower()
```

## Make names more descriptive

2020-12-24, from Michael: Use BH15V1 for number of times arrested.

```{r}
all_visits <- all_visits %>% 
  rename(
    id = subject,
    hispanic = sq_2,
    race = sq_3, # May have to change this to dem3v1
    age = sq_4,
    cell_have = sq_12,
    cell_pays = sq_13,
    cell_talk_minutes = sq_14,
    marital_5_cat = dem1v1,
    n_child = dem2v1,
    edu_19_cat = dem5v1,
    ged = dem5av1,
    employ_9_cat = dem6v1,
    ins_medicare = dem7v1a,
    ins_medicaid = dem7v1b,
    ins_military = dem7v1c,
    ins_private = dem7v1d,
    ins_none = dem7v1e,
    veteran = dem15v1,
    sexual_orientation = dem17v1,
    transgender = dem18v1,
    homeless_time_total = bh1v1,
    homeless_time_years = bh1v1y,
    homeless_time_months = bh1v1m,
    homeless_time_days = bh1v1d,
    homeless_periods = bh2v1,
    homeless_age_first_time = bh3v1,
    homeless_current_total = bh4v1,
    homeless_current_years = bh4v1y,
    homeless_current_months = bh4v1m,
    homeless_current_days = bh4v1d,
    homeless_reason_not_homeless = bh12av1a,
    homeless_reason_lost_job = bh12av1b,
    homeless_reason_evicted = bh12av1c,
    homeless_reason_substance = bh12av1d,
    homeless_reason_mental_illness = bh12av1e,
    homeless_reason_medical_bills = bh12av1f,
    homeless_reason_family = bh12av1g,
    homeless_reason_legal = bh12av1h,
    homeless_reason_jail = bh12av1i,
    homeless_reason_natural_disaster = bh12av1j,
    homeless_reason_domestic_violence = bh12av1k,
    homeless_reason_other = bh12av1l,
    jail_lifetime_n = bh15v1,
    jail_time_total = bh17v1,
    jail_time_years = bh17v1y,
    jail_time_months = bh17v1m,
    jail_time_weeks = bh17v1w,
  ) %>% 
  # Move id and group to the front of the data
  select(id, group, everything())
```

## Recoded and calculated variables

First, I have to remove the "have_labelled" and "vctrs_vctr" class from each variable for if_else() to work.

But, I also need to keep the label attributes. They are erased when I convert the 9's to NA. 

```{r}
# Helper function:
#  Convert 9's to NA's and then add attributes back to vector
nines_to_na <- function(x, nines) {
  # Store the attributes
  x_attr <- attributes(x)
  # Remove "haven_labelled" and "vctrs_vctr" from class list so that if_else()
  # will work.
  # Set class of column to whatever is remaining in the class list.
  classes <- class(x)
  class(x) <- classes[!class(x) %in% c("haven_labelled", "vctrs_vctr")]
  # Convert 9's to NA's
  x <- if_else(x == nines, NA_real_, x)
  # Add attributes back to the vector
  attributes(x) <- x_attr
  # Return x
  x
}

# For testing
# nines_to_na(all_visits$cell_pays, 9) %>% attributes()
```

```{r}
all_visits <- all_visits %>% 
  mutate(
    # The visit dummy variables are currently not coded as 1'a and 0's.
    across(
      .cols = c(visit_v1, visit_v2, visit_v3, visit_v4, visit_v5),
      .fns = ~if_else(!is.na(.x), 1L, 0L)
    ),
    # Convert 9's to NA
    across(
      .cols = c(
        cell_pays, cell_talk_minutes, marital_5_cat, ged, starts_with("ins"), 
        veteran, sexual_orientation, transgender, homeless_periods, 
        starts_with("homeless_reason_"), jail_time_total
      ),
      .fns = ~nines_to_na(.x, 9)
    ),
    # Convert 99's to NA
    across(
      .cols = c(n_child, edu_19_cat, employ_9_cat, jail_lifetime_n),
      .fns = ~nines_to_na(.x, 99)
    ),
    # Convert 999's to NA
    across(
      .cols = c(
        homeless_time_years, homeless_time_months, homeless_time_days, 
        homeless_current_years, homeless_current_months, homeless_current_days, 
        jail_time_years, jail_time_months, jail_time_weeks
      ),
      .fns = ~nines_to_na(.x, 999)
    ),
    # Convert 9999's to NA
    across(
      .cols = c(homeless_time_total, homeless_current_total),
      .fns = ~nines_to_na(.x, 9999)
    )
  )
```

Create a combined insurance variable

```{r}
all_visits <- all_visits %>% 
  rowwise() %>% 
  mutate(
    ins_count = sum(c_across(ins_medicare:ins_private)),
    ins_6_cat = case_when(
      ins_count > 1 ~ 5, # Multiple
      ins_medicare == 1 ~ 1, # Medicare
      ins_medicaid == 1 ~ 2, # Medicaid
      ins_military == 1 ~ 3, # Military
      ins_private == 1 ~ 4, # Private
      ins_none == 1 ~ 6 # None
    ),
    ins_6_cat_f = factor(
      ins_6_cat, 1:6,
      c("Medicare", "Medicaid", "Military", "Private", "Multiple types", "None")
    )
  ) %>% 
  ungroup()
```

Create a combined homelessness reasons variable

```{r}
all_visits <- all_visits %>% 
  rowwise() %>% 
  mutate(
    homeless_reason_count = sum(c_across(homeless_reason_lost_job:homeless_reason_other)),
    homeless_reason_13_cat = case_when(
      homeless_reason_count > 1 ~ 12, # Multiple
      homeless_reason_lost_job == 1 ~ 1, # Lost job
      homeless_reason_evicted == 1 ~ 2, # Evicted
      homeless_reason_substance == 1 ~ 3, # Substance
      homeless_reason_mental_illness == 1 ~ 4, # Mental illness
      homeless_reason_medical_bills == 1 ~ 5, # Medical
      homeless_reason_family == 1 ~ 6, # Family
      homeless_reason_legal == 1 ~ 7, # Legal
      homeless_reason_jail == 1 ~ 8, # Jail
      homeless_reason_natural_disaster == 1 ~ 9, # Natural disaster
      homeless_reason_domestic_violence == 1 ~ 10, # Domestic violence
      homeless_reason_other == 1 ~ 11, # Other
      homeless_reason_not_homeless == 1 ~ 13, # Not homeless
    ),
    homeless_reason_13_cat_f = factor(
      homeless_reason_13_cat, 1:13, c(
        "Lost my job", "Evicted from house/apartment", 
        "Substance use (alcohol or drugs)", "Mental illness", 
        "Inability to pay medical bills", "Family problems", "Legal problems",
        "Recently released from jail or prison", "Natural disaster",
        "Domestic Violence", "Other", "Multiple reasons", "Not homeless"
      )
    )
  ) %>% 
  ungroup()
```

Calculate jail time

2020-12-24, from Michael: You will have to calculate total time in jail because the current variable does not include decimals – here is the syntax to calculate the lifetime period in jail variable: Bh17V1Y + BH17v1M/12 + BH17v1w/52.

Just out of curiosity, I checked for differences between jail_time_total and jail_time_total_c. They are almost identical.

```{r}
all_visits <- all_visits %>% 
  mutate(jail_time_total_c = jail_time_years + (jail_time_months/12) + (jail_time_weeks/52))
```

```{r}
dim(all_visits) # 258 2729
```

## Create factor variables

```{r}
all_visits <- all_visits %>% 
  # Use bind cols to add the new "_f" factor columns to the existing columns in
  # all_visits.
  bind_cols(
    purrr::map_dfc(
      # Choose categorical columns
      .x = quos(
        group, gender, hispanic, race, cell_have, cell_pays, cell_talk_minutes,
        marital_5_cat, n_child, edu_19_cat, ged, employ_9_cat, veteran, 
        sexual_orientation, transgender, homeless_periods, jail_lifetime_n
      ),
      .f = function(x) {
        # Use value labels from SPSS as factor labels. 
        vals <- pull(all_visits, {{ x }})
        levs <- attr(vals, "labels")
        labs <- names(levs)
        name_f <- paste(quo_name({{ x }}), "f", sep = "_")
        tibble(!!name_f := factor(vals, levs, labs))
      }
    )
  )
```

```{r}
dim(all_visits) # 258 2746
```

## Reshape wide to long

The visit variable is currently in wide form. Make longer so that each row represents a unique person/visit combination.

2020-12-14, from Joe: Missing date in TODAY_V. Sometimes QDS did not capture the date for some odd reason. If there is data in VISIT_V or GROUP then the visit occurred. If they are missing data in both of those variables then the visit likely didn’t occur or it happened in REDCap. Below are the records and visits that occurred in REDCap.

2235       Visit 4
2237       Visit 4
2238       Visit 4
2247       Visit 4
2248       Visit 4
2249       Visit 3
2252       Visit 3


NOTE: "If there is data in VISIT_V or GROUP then the visit occurred." can't be right because they are assigned group at visit two. So, they could easily have no date and have been assigned to a group, but not yet attended visit 3. Visit 3 should be 0, not 1. So, we can only use group assignment as a criteria for visits 1 and 2. In other words, if they have no date for visit 2 and no "visit_v" identifier for visit 2, but they have group identifier, then we will say they attended visit 2.

```{r}
all_visits <- all_visits %>% 
  pivot_longer(
    cols = c(starts_with("today"),starts_with("visit")),
    names_to = c(".value", "value"),
    names_pattern = "([a-z]+)_v([1-5])"
  ) %>% 
  # Rename columns
  rename(
    visit = value,
    date = today,
    attend_visit = visit
  ) %>% 
  # Create a calculated version of attend visit using the criteria Joe sent
  # (See above)
  mutate(attend_visit_c = case_when(
    # If there is a date then they attended. I checked and there aren't any
    # cases where there is a date and attend_visit is zero, but I'm putting
    # this rule in anyway.
    !is.na(date) ~ 1L,
    # If there is data in VISIT_V or GROUP then the visit occurred (see above).
    attend_visit == 1 ~ 1L,
    !is.na(group) & visit <= 2 ~ 1L,
    # Add the Redcap cases.
    id == 2235 & visit == 4 ~ 1L,
    id == 2237 & visit == 4 ~ 1L,
    id == 2238 & visit == 4 ~ 1L,
    id == 2247 & visit == 4 ~ 1L,
    id == 2248 & visit == 4 ~ 1L,
    id == 2249 & visit == 3 ~ 1L,
    id == 2252 & visit == 3 ~ 1L,
    # Otherwise, they didn't attend (yet).
    TRUE ~ 0L
  )) %>% 
  # Reorder columns
  select(id, group, date, visit, attend_visit, attend_visit_c, everything())
  
  # For data checking
  # filter(is.na(date) & attend_visit == 1)
  # filter(attend_visit != attend_visit_c)
```

```{r}
dim(all_visits) # 1290 2740
```


# Filter out rows in the table

2020-12-08, from Michael: Can you start by recreating a baseline table with all the variables below (use all participants to date that have completed the baseline and randomization visits)?

## Select people who were randomized only

```{r}
all_visits_randomized <- all_visits %>% 
  filter(group %in% 1:3)
```

```{r}
dim(all_visits_randomized) # 880 2740
```

## Select baseline visits only

```{r}
visit_1_randomized <- all_visits_randomized %>% 
  filter(visit == 1)
```

```{r}
dim(visit_1_randomized) # 176 2740
```

## Keep columns of interest

This is strictly necessary, but it makes the data easier to work with.

```{r}
visit_1_randomized <- visit_1_randomized %>% 
  select(
    id:date, gender_f, hispanic_f, race_f, age, cell_have_f, cell_pays_f, 
    cell_talk_minutes_f, marital_5_cat_f, n_child_f, edu_19_cat_f, employ_9_cat_f,
    ins_6_cat_f, veteran_f, sexual_orientation_f, mms_total, homeless_time_total,
    homeless_current_total, homeless_periods_f, homeless_age_first_time, 
    homeless_reason_13_cat_f, jail_time_total_c
  )
```

```{r}
dim(visit_1_randomized) # 176 24
```










